name: build

on: [push, pull_request]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        BUILD_TYPE: ["Debug", "Release"]
        os: [ ubuntu-latest, windows-latest ]
    steps:
    - uses: actions/checkout@v2

    - name: Get specific version CMake, v3.21.2
      uses: lukka/get-cmake@v3.21.2
    
    - name: run cmake
      run: cmake . -DCMAKE_BUILD_TYPE=${{ matrix.BUILD_TYPE }} -B build

    - name: run build
      run: cmake --build build --config ${{ matrix.BUILD_TYPE }}

    # only make windows release
    - name: set release flag
      id: release-flag
      if: |
        startsWith(github.ref, 'refs/tags/') &&
        matrix.BUILD_TYPE == 'Release' &&
        matrix.os == 'windows-latest'
      run: echo "::set-output name=make_release::yes"

    # - name: debug release flag
    #   run: echo "make release ${{ steps.release-flag.outputs.make_release }}"
    
    # - name: debug if release flag
    #   if: steps.release-flag.outputs.make_release == 'yes'
    #   run: echo "make relase detected"

    - name: prepare release
      if:  steps.release-flag.outputs.make_release == 'yes'
      run: |
        Compress-Archive -Path build/Release -DestinationPath .\cscope-windows.zip
        Get-FileHash .\cscope-windows.zip -Algorithm SHA256 | Select-Object -ExpandProperty Hash | Out-File sha256sum.txt

    - name: make release
      uses: softprops/action-gh-release@v1
      if:  steps.release-flag.outputs.make_release == 'yes'
      with:
        files: |
          cscope-windows.zip
          sha256sum.txt